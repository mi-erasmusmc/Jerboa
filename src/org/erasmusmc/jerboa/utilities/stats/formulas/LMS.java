/***********************************************************************************
 *                                                                                 *
 * Copyright (C) 2017  Erasmus MC, Rotterdam, The Netherlands                      *
 *                                                                                 *
 * This file is part of Jerboa.                                                    *
 *                                                                                 *
 * This program is free software; you can redistribute it and/or                   *
 * modify it under the terms of the GNU General Public License                     *
 * as published by the Free Software Foundation; either version 2                  *
 * of the License, or (at your option) any later version.                          *
 *                                                                                 *
 * This program is distributed in the hope that it will be useful,                 *
 * but WITHOUT ANY WARRANTY; without even the implied warranty of                  *
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the                   *
 * GNU General Public License for more details.                                    *
 *                                                                                 *
 * You should have received a copy of the GNU General Public License               *
 * along with this program; if not, write to the Free Software                     *
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA. *
 *                                                                                 *
 ***********************************************************************************/

/******************************************************************************************
 * Jerboa software version 3.0 - Copyright Erasmus University Medical Center, Rotterdam   *
 *																				          *
 * Author: Peter Rijnbeek (PR) - department of Medical Informatics						  *
 * 																						  *
 * $Rev:: 3961              $:  Revision of last commit                                   *
 * $Author:: root           $:  Author of last commit                                     *
 * $Date:: 2013-05#$:  Date and time (CET) of last commit								  *
 ******************************************************************************************/
package org.erasmusmc.jerboa.utilities.stats.formulas;

import org.apache.commons.math3.distribution.NormalDistribution;
import org.apache.commons.math3.linear.Array2DRowRealMatrix;
import org.apache.commons.math3.linear.RealMatrix;
import org.apache.commons.math3.linear.RealVector;
import org.erasmusmc.jerboa.utilities.stats.LMSReference;

/**
 * This class implements Cole's LMS method as published in
 * Cole	TJ. The LMS method for constructing normalized growth standards. Eur J Clin Nutr. 1990 Jan;44(1:45-60).
 * Bases on the L (skewness), M (mean), S (SD) age-dependent curves the distribution and thus the percentiles
 * can be calculated for each age and gender.
 *
 * @author PR
 *
 */
public class LMS {

	//holds the age-dependent L,M,S reference values
	private  RealMatrix reference;

	//CONSTRUCTORS
	/**
	 * Constructor to instantiate with a reference matrix.
	 * @param reference - the reference matrix in the format:
	 * 					  				Male		Female
	 * 					  age(months) 	L	M 	S	L	M	S
	 */
	public LMS(RealMatrix reference){
		this.reference = reference;
	}

	/**
	 * Constructor accepting the reference name and initializing the
	 * reference matrix accordingly.
	 * @param reference - the reference of interest
	 */
	public LMS(String reference){
		this.reference = LMSReference.init(reference);
	}

	/**
	 * calculates the value of a percentile at a given age for a given gender.
	 * @param age - the age in months
	 * @param male - true/false
	 * @param percentile - percentile for example 95.0
	 * @return - the value based on the reference
	 */
	public double calcPercentileValue(double age, boolean male, double percentile){
		RealVector lms = getLMS(age, male);
		double L = lms.getEntry(0);
		double M = lms.getEntry(1);
		double S = lms.getEntry(2);
		NormalDistribution normalDist = new NormalDistribution();
		double norminv = normalDist.inverseCumulativeProbability(percentile/100);
		double percValue = 0;

		if (L==0){
			percValue = M*Math.exp(S*norminv);
		} else {
			percValue = M*Math.pow(1+L*S*norminv, 1/L);
		}

		return percValue;
	}

	/**
	 * Calculates the z-score of a value at a given age for a given gender.
	 * @param age - the age in months
	 * @param male - true/false
	 * @param value - the value to be considered
	 * @return - the z-score based on the reference
	 */
	public double getZscore(double age, boolean male, double value){
		RealVector lms = getLMS(age, male);
		double L = lms.getEntry(0);
		double M = lms.getEntry(1);
		double S = lms.getEntry(2);

		return (Math.pow(value/M,L)-1)/(L*S);
	}

	/**
	 * Calculates the percentile based on the reference for a certain value.
	 * @param age - the age in months
	 * @param male - true/false
	 * @param value - the value to be considered
	 * @return - the percentile, for example 95.0
	 */
	public double getPercentile(double age, boolean male, double value){
		double zscore = getZscore(age,male,value);
		NormalDistribution normalDist = new NormalDistribution();
		double percentile = normalDist.cumulativeProbability(zscore);

		return Math.floor(percentile*1000)/10;
	}

	/**
	 * Creates a matrix of the percentile curves of the reference.
	 * The matrix is created for the ages starting from a minimum until
	 * a maximum age, by fixed step size (months)
	 * @param percentiles - array of percentile, for example [2,5,95,98]
	 * @param min - minimum value in months
	 * @param max - maximum value in months
	 * @param step - step size in months
	 * @param male - true/false
	 * @return - matrix in the following format
	 * 			 age	2	5	95	98
	 */
	public RealMatrix getPercentileMatrix(double[] percentiles, double min, double max, double step, boolean male){

		int length = (int) ((max-min)/step)+1;
		double[][] matrix = new double[length][percentiles.length+1];

		for (int i=0;i<length;i++){
			double age = min+i*step;
			matrix[i][0] = age;
			for(int j=1;j<percentiles.length+1;j++){
				matrix[i][j] = calcPercentileValue(age,male,percentiles[j-1]);
			}
		}

		return new Array2DRowRealMatrix(matrix);
	}

	/**
	 * calculates the LMS values for this age and gender.
	 * @param age - the age in months
	 * @param male - true/false
	 * @return - RealVector containing [L,M,S] values
	 */
	public RealVector getLMS(double age, boolean male) {

		//find the reference value below and above and interpolate
		RealVector below = reference.getRowVector(0);
		RealVector above = reference.getRowVector(reference.getRowDimension()-1);

		for (int i=0;i<reference.getRowDimension();i++){
			if (age>=reference.getEntry(i, 0)){
				below = reference.getRowVector(i).copy();
				above = reference.getRowVector(i).copy();
			}
			if (reference.getEntry(i, 0)>age){
				above = reference.getRowVector(i).copy();
				break;
			}
		}
		double below_age = below.getEntry(0);
		double above_age = above.getEntry(0);

		//double increment = age - Math.floor(age+0.5)+0.5; //interpolation factor
		double increment;
		if (above_age != below_age) //true if equal to last age in reference
			increment = (age - below_age) / (above_age - below_age); //interpolation factor
	    else
	    	increment = 0;

		//result = (1-increment)*below + increment*above
		below.mapMultiplyToSelf(1-increment);
		above.mapMultiplyToSelf(increment);

		RealVector result = below.add(above);

		//return the LMS values for the right gender
		if (male){
			return result.getSubVector(1,3);
		} else {
			return result.getSubVector(4,3);
		}
	}

	/**
	 * Main for debugging using the CDC 2000 reference for BMI
	 * @param args - none
	 */
	public static void main(String[] args) {

		//populate the BMI LMS values for CDC growth chart 2000
		RealMatrix BMIReference = new Array2DRowRealMatrix(new double[][] {
			{23.5,-2.0399885450,16.6022804830,0.0810575012,-0.9487202330,16.4587527250,0.0858777320},
			{24.5,-1.9823735950,16.5477748670,0.0801274288,-1.0244968270,16.3880405610,0.0850258380},
			{25.5,-1.9241001690,16.4944276320,0.0792339937,-1.1026983530,16.3189719010,0.0842140522},
			{26.5,-1.8654979300,16.4425955220,0.0783893561,-1.1839663500,16.2520798450,0.0834551240},
			{27.5,-1.8072618990,16.3922433980,0.0775935012,-1.2680710360,16.1873466860,0.0827482842},
			{28.5,-1.7501189050,16.3433365430,0.0768464622,-1.3547515250,16.1247544810,0.0820927371},
			{29.5,-1.6948158400,16.2958409710,0.0761483079,-1.4436896920,16.0642876230,0.0814877172},
			{30.5,-1.6421067790,16.2497237140,0.0754991255,-1.5345419200,16.0059300070,0.0809324482},
			{31.5,-1.5927444140,16.2049526780,0.0748989935,-1.6269280930,15.9496663100,0.0804261754},
			{32.5,-1.5474423910,16.1614987140,0.0743479966,-1.7204348290,15.8954819690,0.0799681758},
			{33.5,-1.5069026010,16.1193325820,0.0738461386,-1.8146352620,15.8433617910,0.0795577348},
			{34.5,-1.4717700470,16.0784275790,0.0733933698,-1.9090762620,15.7932914560,0.0791941867},
			{35.5,-1.4426289570,16.0387589580,0.0729895508,-2.0032961020,15.7452564000,0.0788768946},
			{36.5,-1.4199912550,16.0003040120,0.0726344323,-2.0968289370,15.6992418780,0.0786052551},
			{37.5,-1.4042776190,15.9630427710,0.0723276490,-2.1892118770,15.6552328230,0.0783786964},
			{38.5,-1.3958631700,15.9269541750,0.0720686401,-2.2799919820,15.6132137090,0.0781966743},
			{39.5,-1.3949352520,15.8920258160,0.0718568052,-2.3687329490,15.5731684270,0.0780586670},
			{40.5,-1.4016715960,15.8582409290,0.0716912780,-2.4550213140,15.5350801900,0.0779641690},
			{41.5,-1.4161003120,15.8255882230,0.0715710933,-2.5384719720,15.4989314490,0.0779126837},
			{42.5,-1.4381648990,15.7940572820,0.0714951131,-2.6187329010,15.4647038440,0.0779037156},
			{43.5,-1.4676690320,15.7636425490,0.0714621062,-2.6954889730,15.4323781680,0.0779367628},
			{44.5,-1.5043763470,15.7343366840,0.0714706462,-2.7684648160,15.4019343640,0.0780113090},
			{45.5,-1.5479428380,15.7061356570,0.0715192177,-2.8374266930,15.3733515410,0.0781268172},
			{46.5,-1.5978963970,15.6790406230,0.0716062769,-2.9021782050,15.3466084150,0.0782827393},
			{47.5,-1.6537322830,15.6530519160,0.0717301670,-2.9625803860,15.3216818140,0.0784784485},
			{48.5,-1.7148693470,15.6281726920,0.0718892136,-3.0185219870,15.2985489720,0.0787133246},
			{49.5,-1.7806731810,15.6044079970,0.0720817373,-3.0699365550,15.2771861790,0.0789866938},
			{50.5,-1.8504684730,15.5817645800,0.0723060813,-3.1167958640,15.2575692040,0.0792978405},
			{51.5,-1.9235518650,15.5602506660,0.0725606369,-3.1591073310,15.2396733840,0.0796460060},
			{52.5,-1.9992204290,15.5398745970,0.0728438397,-3.1969110830,15.2234737100,0.0800303887},
			{53.5,-2.0767071780,15.5206499270,0.0731543235,-3.2302767590,15.2089449070,0.0804501449},
			{54.5,-2.1553480170,15.5025842670,0.0734906668,-3.2593001820,15.1960615200,0.0809043905},
			{55.5,-2.2344385520,15.4856897320,0.0738516716,-3.2840999630,15.1847979870,0.0813922027},
			{56.5,-2.3133217230,15.4699771770,0.0742362346,-3.3048141500,15.1751287080,0.0819126232},
			{57.5,-2.3913812730,15.4554569160,0.0746433738,-3.3215969540,15.1670281070,0.0824646608},
			{58.5,-2.4680324910,15.4421396080,0.0750722636,-3.3346156460,15.1604706840,0.0830472946},
			{59.5,-2.5427815410,15.4300320720,0.0755221037,-3.3440476220,15.1554310670,0.0836594775},
			{60.5,-2.6151659500,15.4191416310,0.0759922501,-3.3500777100,15.1518840500,0.0843001394},
			{61.5,-2.6847895160,15.4094735610,0.0764821284,-3.3528938050,15.1498047880,0.0849681996},
			{62.5,-2.7513169490,15.4010313880,0.0769912324,-3.3526913760,15.1491682500,0.0856625390},
			{63.5,-2.8144594500,15.3938178520,0.0775191487,-3.3496643800,15.1499498350,0.0863820350},
			{64.5,-2.8740247600,15.3878309360,0.0780653898,-3.3439988030,15.1521258520,0.0871255909},
			{65.5,-2.9298404800,15.3830694480,0.0786295919,-3.3358895740,15.1556718620,0.0878920466},
			{66.5,-2.9817968280,15.3795295800,0.0792113694,-3.3255224910,15.1605641920,0.0886802643},
			{67.5,-3.0298313430,15.3772058200,0.0798103341,-3.3130784600,15.1667794730,0.0894891056},
			{68.5,-3.0739242240,15.3760910680,0.0804260861,-3.2987326480,15.1742946410,0.0903174340},
			{69.5,-3.1140934760,15.3761767650,0.0810582059,-3.2826538310,15.1830869360,0.0911641168},
			{70.5,-3.1503900400,15.3774530400,0.0817062489,-3.2650038960,15.1931338960,0.0920280276},
			{71.5,-3.1828930180,15.3799088590,0.0823697413,-3.2459375060,15.2044133480,0.0929080476},
			{72.5,-3.2117051100,15.3835321690,0.0830481778,-3.2256065160,15.2169029570,0.0938030328},
			{73.5,-3.2369483400,15.3883100460,0.0837410207,-3.2041461150,15.2305815040,0.0947119161},
			{74.5,-3.2587601100,15.3942288300,0.0844476998,-3.1816902370,15.2454274480,0.0956335947},
			{75.5,-3.2772815460,15.4012749600,0.0851676514,-3.1583634750,15.2614196640,0.0965669920},
			{76.5,-3.2926837740,15.4094325200,0.0859001836,-3.1342828330,15.2785372780,0.0975110459},
			{77.5,-3.3051240730,15.4186869110,0.0866446671,-3.1095578790,15.2967596670,0.0984647101},
			{78.5,-3.3147689510,15.4290227320,0.0874004212,-3.0842909310,15.3160664420,0.0994269552},
			{79.5,-3.3217859920,15.4404243870,0.0881667444,-3.0585772920,15.3364374470,0.1003967693},
			{80.5,-3.3263457950,15.4528758060,0.0889428970,-3.0325054990,15.3578527440,0.1013731591},
			{81.5,-3.3286027310,15.4663621780,0.0897282019,-3.0061576000,15.3802926130,0.1023551503},
			{82.5,-3.3287252770,15.4808670410,0.0905218748,-2.9796094480,15.4037375350,0.1033417884},
			{83.5,-3.3268701800,15.4963746540,0.0913231621,-2.9529309930,15.4281681910,0.1043321392},
			{84.5,-3.3231888960,15.5128693630,0.0921313054,-2.9261865920,15.4535654520,0.1053252892},
			{85.5,-3.3178270160,15.5303356320,0.0929455443,-2.8994353070,15.4799103740,0.1063203463},
			{86.5,-3.3109238710,15.5487580650,0.0937651184,-2.8727312110,15.5071841870,0.1073164399},
			{87.5,-3.3026122720,15.5681214260,0.0945892702,-2.8461236830,15.5353682930,0.1083127212},
			{88.5,-3.2930183610,15.5884106510,0.0954172465,-2.8196577040,15.5644442570,0.1093083637},
			{89.5,-3.2822608130,15.6096110100,0.0962483005,-2.7933741450,15.5943938020,0.1103025629},
			{90.5,-3.2704546090,15.6317073500,0.0970816941,-2.7673100470,15.6251987980,0.1112945370},
			{91.5,-3.2577036160,15.6546856280,0.0979166976,-2.7414988970,15.6568412590,0.1122835261},
			{92.5,-3.2441082140,15.6785313870,0.0987525931,-2.7159708940,15.6893033340,0.1132687930},
			{93.5,-3.2297617130,15.7032305180,0.0995886749,-2.6907531970,15.7225672990,0.1142496222},
			{94.5,-3.2147512870,15.7287691130,0.1004242507,-2.6658701460,15.7566155530,0.1152253207},
			{95.5,-3.1991581840,15.7551334650,0.1012586429,-2.6413434360,15.7914306220,0.1161952181},
			{96.5,-3.1830579500,15.7823100650,0.1020911894,-2.6171922040,15.8269951690,0.1171586674},
			{97.5,-3.1665206640,15.8102856030,0.1029212448,-2.5934306140,15.8632924070,0.1181150731},
			{98.5,-3.1496103000,15.8390470840,0.1037481885,-2.5700760370,15.9003048410,0.1190638073},
			{99.5,-3.1323896370,15.8685812290,0.1045713862,-2.5471414730,15.9380154460,0.1200042898},
			{100.5,-3.1149111530,15.8988756180,0.1053902685,-2.5246352450,15.9764078710,0.1209359936},
			{101.5,-3.0972263990,15.9299176510,0.1062042575,-2.5025696660,16.0154648340,0.1218583548},
			{102.5,-3.0793830790,15.9616948050,0.1070127883,-2.4809518900,16.0551698440,0.1227708703},
			{103.5,-3.0614237650,15.9941948940,0.1078153274,-2.4597855730,16.0955068800,0.1236730846},
			{104.5,-3.0433860710,16.0274060710,0.1086113736,-2.4390801170,16.1364588090,0.1245644841},
			{105.5,-3.0253100030,16.0613158970,0.1094003876,-2.4188383040,16.1780095510,0.1254446390},
			{106.5,-3.0072257370,16.0959129220,0.1101819146,-2.3990636830,16.2201428130,0.1263131206},
			{107.5,-2.9891645980,16.1311853150,0.1109554781,-2.3797568610,16.2628427710,0.1271695453},
			{108.5,-2.9711482250,16.1671223440,0.1117206908,-2.3609205270,16.3060931620,0.1280135154},
			{109.5,-2.9532080470,16.2037116770,0.1124770587,-2.3425577280,16.3498775860,0.1288446388},
			{110.5,-2.9353639510,16.2409423880,0.1132241995,-2.3246633260,16.3941811800,0.1296626372},
			{111.5,-2.9176351570,16.2788034580,0.1139617339,-2.3072407160,16.4389874130,0.1304671382},
			{112.5,-2.9000398030,16.3172838470,0.1146892914,-2.2902876630,16.4842808230,0.1312578524},
			{113.5,-2.8825937960,16.3563726720,0.1154065227,-2.2738038470,16.5300455380,0.1320344789},
			{114.5,-2.8653112660,16.3960591610,0.1161130971,-2.2577821490,16.5762671300,0.1327968190},
			{115.5,-2.8482046970,16.4363326450,0.1168087018,-2.2422277230,16.6229286400,0.1335445247},
			{116.5,-2.8312850520,16.4771825560,0.1174930418,-2.2271328050,16.6700157160,0.1342774356},
			{117.5,-2.8145618900,16.5185984250,0.1181658396,-2.2124955850,16.7175128770,0.1349953236},
			{118.5,-2.7980434700,16.5605698730,0.1188268351,-2.1983127500,16.7654049610,0.1356979956},
			{119.5,-2.7817368560,16.6030866120,0.1194757852,-2.1845807620,16.8136768860,0.1363852755},
			{120.5,-2.7656480080,16.6461384390,0.1201124636,-2.1712958880,16.8623136560,0.1370570042},
			{121.5,-2.7497821970,16.6897151780,0.1207366562,-2.1584542320,16.9113003570,0.1377130391},
			{122.5,-2.7341424430,16.7338069530,0.1213481813,-2.1460517540,16.9606221560,0.1383532537},
			{123.5,-2.7187328730,16.7784036320,0.1219468490,-2.1340843030,17.0102643040,0.1389775374},
			{124.5,-2.7035555060,16.8234953800,0.1225325012,-2.1225476290,17.0602121330,0.1395857952},
			{125.5,-2.6886119570,16.8690723750,0.1231049908,-2.1114374110,17.1104510550,0.1401779469},
			{126.5,-2.6739031640,16.9151248660,0.1236641859,-2.1007492660,17.1609665640,0.1407539274},
			{127.5,-2.6594294430,16.9616431680,0.1242099694,-2.0904787740,17.2117442360,0.1413136859},
			{128.5,-2.6451905340,17.0086176600,0.1247422387,-2.0806214840,17.2627697280,0.1418571858},
			{129.5,-2.6311856490,17.0560387870,0.1252609054,-2.0711729320,17.3140287760,0.1423844043},
			{130.5,-2.6174135110,17.1038970520,0.1257658950,-2.0621286490,17.3655071990,0.1428953318},
			{131.5,-2.6038723920,17.1521830220,0.1262571467,-2.0534841730,17.4171908950,0.1433899720},
			{132.5,-2.5905601480,17.2008873180,0.1267346133,-2.0452350580,17.4690658450,0.1438683412},
			{133.5,-2.5774742530,17.2500006230,0.1271982604,-2.0373768800,17.5211181100,0.1443304685},
			{134.5,-2.5646118310,17.2995136730,0.1276480666,-2.0299066840,17.5733334690,0.1447763715},
			{135.5,-2.5519696840,17.3494172580,0.1280840230,-2.0228179140,17.6256986880,0.1452061381},
			{136.5,-2.5395399720,17.3997030810,0.1285061919,-2.0161070840,17.6781998680,0.1456198193},
			{137.5,-2.5273256810,17.4503607150,0.1289144974,-2.0097699050,17.7308233970,0.1460174906},
			{138.5,-2.5153202350,17.5013816060,0.1293090012,-2.0038021340,17.7835557460,0.1463992386},
			{139.5,-2.5035194470,17.5527567390,0.1296897408,-1.9981995720,17.8363834710,0.1467651605},
			{140.5,-2.4919189340,17.6044771440,0.1300567649,-1.9929580640,17.8892932090,0.1471153639},
			{141.5,-2.4805141360,17.6565338950,0.1304101325,-1.9880735050,17.9422716840,0.1474499668},
			{142.5,-2.4693003310,17.7089181070,0.1307499132,-1.9835418350,17.9953057040,0.1477690965},
			{143.5,-2.4582726560,17.7616209380,0.1310761867,-1.9793590410,18.0483821620,0.1480728906},
			{144.5,-2.4474261130,17.8146335860,0.1313890423,-1.9755211560,18.1014880360,0.1483614954},
			{145.5,-2.4367555950,17.8679472890,0.1316885791,-1.9720242580,18.1546103940,0.1486350668},
			{146.5,-2.4262558870,17.9215533200,0.1319749052,-1.9688644650,18.2077363860,0.1488937694},
			{147.5,-2.4159216890,17.9754429920,0.1322481377,-1.9660379380,18.2608532530,0.1491377764},
			{148.5,-2.4057476190,18.0296076530,0.1325084026,-1.9635408720,18.3139483240,0.1493672695},
			{149.5,-2.3957282330,18.0840386840,0.1327558343,-1.9613694990,18.3670090170,0.1495824386},
			{150.5,-2.3858580290,18.1387275010,0.1329905752,-1.9595200790,18.4200228390,0.1497834816},
			{151.5,-2.3761314590,18.1936655520,0.1332127760,-1.9579889000,18.4729773880,0.1499706043},
			{152.5,-2.3665429420,18.2488443140,0.1334225948,-1.9567722710,18.5258603520,0.1501440201},
			{153.5,-2.3570868710,18.3042552960,0.1336201973,-1.9558665200,18.5786595130,0.1503039498},
			{154.5,-2.3477576250,18.3598900340,0.1338057563,-1.9552679840,18.6313627450,0.1504506214},
			{155.5,-2.3385495760,18.4157400920,0.1339794518,-1.9549730110,18.6839580130,0.1505842702},
			{156.5,-2.3294571000,18.4717970590,0.1341414703,-1.9549779470,18.7364333810,0.1507051384},
			{157.5,-2.3204745860,18.5280525490,0.1342920051,-1.9552791360,18.7887770040,0.1508134748},
			{158.5,-2.3115964460,18.5844981990,0.1344312555,-1.9558729090,18.8409771340,0.1509095352},
			{159.5,-2.3028171240,18.6411256650,0.1345594270,-1.9567555790,18.8930221210,0.1509935818},
			{160.5,-2.2941311070,18.6979266270,0.1346767311,-1.9579234360,18.9449004110,0.1510658829},
			{161.5,-2.2855329330,18.7548927810,0.1347833849,-1.9593727370,18.9966005490,0.1511267136},
			{162.5,-2.2770172010,18.8120158390,0.1348796107,-1.9610997000,19.0481111790,0.1511763547},
			{163.5,-2.2685785840,18.8692875280,0.1349656365,-1.9631004960,19.0994210460,0.1512150935},
			{164.5,-2.2602118370,18.9266995900,0.1350416951,-1.9653712400,19.1505189940,0.1512432229},
			{165.5,-2.2519118090,18.9842437750,0.1351080243,-1.9679079830,19.2013939710,0.1512610419},
			{166.5,-2.2436734530,19.0419118450,0.1351648666,-1.9707067060,19.2520350260,0.1512688553},
			{167.5,-2.2354918420,19.0996955680,0.1352124688,-1.9737633070,19.3024313120,0.1512669735},
			{168.5,-2.2273621730,19.1575867160,0.1352510825,-1.9770735950,19.3525720850,0.1512557127},
			{169.5,-2.2192797900,19.2155770650,0.1352809633,-1.9806332770,19.4024467070,0.1512353947},
			{170.5,-2.2112401870,19.2736583900,0.1353023707,-1.9844379540,19.4520446460,0.1512063468},
			{171.5,-2.2032390290,19.3318224660,0.1353155684,-1.9884831060,19.5013554760,0.1511689019},
			{172.5,-2.1952721610,19.3900610610,0.1353208237,-1.9927640850,19.5503688760,0.1511233983},
			{173.5,-2.1873356250,19.4483659380,0.1353184074,-1.9972761030,19.5990746370,0.1510701797},
			{174.5,-2.1794256740,19.5067288480,0.1353085942,-2.0020142240,19.6474626550,0.1510095954},
			{175.5,-2.1715387890,19.5651415320,0.1352916617,-2.0069733500,19.6955229370,0.1509419999},
			{176.5,-2.1636716890,19.6235957140,0.1352678911,-2.0121482130,19.7432455970,0.1508677534},
			{177.5,-2.1558213570,19.6820831010,0.1352375667,-2.0175333630,19.7906208620,0.1507872211},
			{178.5,-2.1479850460,19.7405953760,0.1352009759,-2.0231231590,19.8376390680,0.1507007738},
			{179.5,-2.1401603050,19.7991242010,0.1351584088,-2.0289117550,19.8842906620,0.1506087878},
			{180.5,-2.1323449890,19.8576612090,0.1351101588,-2.0348930910,19.9305662030,0.1505116446},
			{181.5,-2.1245372820,19.9161980040,0.1350565219,-2.0410608810,19.9764563610,0.1504097312},
			{182.5,-2.1167357120,19.9747261540,0.1349977968,-2.0474086040,20.0219519170,0.1503034402},
			{183.5,-2.1089391670,20.0332371940,0.1349342850,-2.0539294900,20.0670437650,0.1501931693},
			{184.5,-2.1011469200,20.0917226150,0.1348662908,-2.0606165130,20.1117229100,0.1500793222},
			{185.5,-2.0933586370,20.1501738700,0.1347941208,-2.0674623750,20.1559804690,0.1499623077},
			{186.5,-2.0855744030,20.2085823610,0.1347180845,-2.0744595020,20.1998076720,0.1498425404},
			{187.5,-2.0777947350,20.2669394440,0.1346384938,-2.0816000290,20.2431958570,0.1497204407},
			{188.5,-2.0700205990,20.3252364240,0.1345556632,-2.0888757930,20.2861364770,0.1495964342},
			{189.5,-2.0622534310,20.3834645480,0.1344699098,-2.0962783230,20.3286210930,0.1494709526},
			{190.5,-2.0544951450,20.4416150080,0.1343815533,-2.1037988280,20.3706413760,0.1493444333},
			{191.5,-2.0467481560,20.4996789350,0.1342909159,-2.1114281940,20.4121891060,0.1492173194},
			{192.5,-2.0390153850,20.5576473990,0.1341983225,-2.1191569720,20.4532561720,0.1490900600},
			{193.5,-2.0313002820,20.6155114040,0.1341041006,-2.1269753750,20.4938345700,0.1489631101},
			{194.5,-2.0236068280,20.6732618890,0.1340085806,-2.1348732660,20.5339164000,0.1488369306},
			{195.5,-2.0159420130,20.7308890510,0.1339120657,-2.1428401570,20.5734938690,0.1487119885},
			{196.5,-2.0083057450,20.7883851020,0.1338149542,-2.1508652040,20.6125592850,0.1485887569},
			{197.5,-2.0007063890,20.8457400290,0.1337175518,-2.1589372010,20.6511050580,0.1484677151},
			{198.5,-1.9931501370,20.9029444940,0.1336202002,-2.1670445780,20.6891236980,0.1483493484},
			{199.5,-1.9856437410,20.9599890880,0.1335232441,-2.1751769870,20.7266072820,0.1482341202},
			{200.5,-1.9781945100,21.0168643300,0.1334270316,-2.1833173620,20.7635501050,0.1481226140},
			{201.5,-1.9708103080,21.0735606740,0.1333319137,-2.1914577920,20.7999433740,0.1480152488},
			{202.5,-1.9634995400,21.1300685010,0.1332382449,-2.1995836490,20.8357805100,0.1479125643},
			{203.5,-1.9562711410,21.1863781310,0.1331463832,-2.2076815250,20.8710544930,0.1478150781},
			{204.5,-1.9491345610,21.2424798190,0.1330566901,-2.2157376450,20.9057583940,0.1477233147},
			{205.5,-1.9420997440,21.2983637590,0.1329695305,-2.2237399020,20.9398847690,0.1476377678},
			{206.5,-1.9351771010,21.3540200940,0.1328852735,-2.2316679950,20.9734285780,0.1475590832},
			{207.5,-1.9283774800,21.4094389110,0.1328042916,-2.2395119420,21.0063817050,0.1474877162},
			{208.5,-1.9217121360,21.4646102570,0.1327269615,-2.2472570810,21.0387374020,0.1474242097},
			{209.5,-1.9151926850,21.5195241360,0.1326536641,-2.2548851450,21.0704899590,0.1473691743},
			{210.5,-1.9088310650,21.5741705250,0.1325847841,-2.2623820900,21.1016324070,0.1473231440},
			{211.5,-1.9026394820,21.6285393730,0.1325207109,-2.2697315170,21.1321584470,0.1472866982},
			{212.5,-1.8966303580,21.6826206180,0.1324618378,-2.2769172290,21.1620617080,0.1472604146},
			{213.5,-1.8908162680,21.7364041910,0.1324085629,-2.2839254420,21.1913350970,0.1472448281},
			{214.5,-1.8852098760,21.7898800290,0.1323612888,-2.2907314420,21.2199747160,0.1472406828},
			{215.5,-1.8798235050,21.8430381910,0.1323204265,-2.2973242700,21.2479726230,0.1472484670},
			{216.5,-1.8746703240,21.8958685010,0.1322863818,-2.3036878020,21.2753223890,0.1472687698},
			{217.5,-1.8697602990,21.9483616840,0.1322595999,-2.3097999710,21.3020193250,0.1473022986},
			{218.5,-1.8651132450,22.0005056900,0.1322404176,-2.3156518740,21.3280548940,0.1473495144},
			{219.5,-1.8607349440,22.0522924230,0.1322293301,-2.3212173100,21.3534256290,0.1474112153},
			{220.5,-1.8566338400,22.1037130480,0.1322268010,-2.3264819110,21.3781246160,0.1474879793},
			{221.5,-1.8528271860,22.1547560290,0.1322332005,-2.3314281390,21.4021458920,0.1475804525},
			{222.5,-1.8493232040,22.2054124850,0.1322489931,-2.3360384730,21.4254835140,0.1476892889},
			{223.5,-1.8461316070,22.2556730000,0.1322746254,-2.3402954500,21.4481315580,0.1478151501},
			{224.5,-1.8432612940,22.3055283060,0.1323105490,-2.3441817030,21.4700841160,0.1479587057},
			{225.5,-1.8407202480,22.3549692990,0.1323572208,-2.3476800000,21.4913352860,0.1481206332},
			{226.5,-1.8385154400,22.4039870570,0.1324151030,-2.3507732860,21.5118791760,0.1483016185},
			{227.5,-1.8366558600,22.4525718180,0.1324846310,-2.3534447250,21.5317098940,0.1485023554},
			{228.5,-1.8351380460,22.5007177810,0.1325663592,-2.3556777430,21.5508215470,0.1487235462},
			{229.5,-1.8339720040,22.5484143720,0.1326606990,-2.3574560700,21.5692082370,0.1489659018},
			{230.5,-1.8331577510,22.5956542150,0.1327681527,-2.3587637880,21.5868640570,0.1492301415},
			{231.5,-1.8326956200,22.6424295570,0.1328892105,-2.3595853690,21.6037830870,0.1495169936},
			{232.5,-1.8325843420,22.6887329210,0.1330243684,-2.3599057260,21.6199593880,0.1498271951},
			{233.5,-1.8328209740,22.7345571260,0.1331741285,-2.3597102580,21.6353870020,0.1501614923},
			{234.5,-1.8334008250,22.7798952950,0.1333389994,-2.3589804640,21.6500612620,0.1505207340},
			{235.5,-1.8343174050,22.8247408680,0.1335194959,-2.3577145080,21.6639726950,0.1509054394},
			{236.5,-1.8355575200,22.8690891160,0.1337161923,-2.3558924240,21.6771173550,0.1513165313},
			{237.5,-1.8371194660,22.9129315080,0.1339295249,-2.3535013530,21.6894893520,0.1517548077},
			{238.5,-1.8389870630,22.9562637330,0.1341600729,-2.3505287260,21.7010828840,0.1522210861},
			{239.5,-1.8411461390,22.9990806160,0.1344083809,-2.3469622470,21.7118922520,0.1527162055},
			{240.5,-1.8435141810,23.0415078600,0.1346703491,-2.3429546130,21.7221064320,0.1532332305}
		},false);

		//instantiate a new LMS object with this reference
		LMS lms = new LMS(BMIReference);

		//a test case
		double age = 96.5585215605749;
		boolean male = false;
		double BMI = 29.8394097222222;

		//show class in action
		System.out.println("LMS: " + lms.getLMS(age, male));
		System.out.println("z-score: " + lms.getZscore(age, male, BMI));
		System.out.println("percentile: " + lms.getPercentile(age, male, BMI));

		double [] percentiles = new double[]{1,2,5,10,25,50,75,80,95,98,99};
		double min=24;
		double max=240;
		double step = 12;
		RealMatrix percentileMatrix = lms.getPercentileMatrix(percentiles,min,max,step,male);
	//	RealMatrix matrix = new Array2DRowRealMatrix(percentileMatrix);

		System.out.println("Matrix:");
		System.out.println(percentileMatrix.toString());
	}

}
